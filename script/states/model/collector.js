const ee={undefined:!1,fieldSeparator:",",lineSeparator:"\n",quote:'"'},te=(e,t)=>{if(!t.undefined||e.length)return e},ae=(e,t,a)=>{t.push(e),a.field++,a.fieldOffset=-1,a.appendField=!1},re=(e,t,a)=>{t.push(e),a.field=0,a.line++,a.lineOffset=-1,a.appendRow=!1},ne=(e,t=ee)=>new Promise(a=>{((e,t=ee)=>{const a=Object.assign({},ee,t),r={field:0,fieldOffset:0,line:0,lineOffset:0,quoted:!1,appendCell:!1,appendField:!1,appendRow:!1};return new Promise((t,n)=>{if(e.length){const s=[];let o=[],l="";for(let t=0;t<e.length;t++)r.appendCell=!0,e[t]===a.quote?t&&"\\"!==e[t-1]?(!l.length||r.quoted?r.quoted=!r.quoted:n(Error(`Invalid CSV text at offset ${r.line}:${r.lineOffset}`)),r.appendCell=!1):l=l.substr(0,l.length-1):e[t]===a.fieldSeparator?r.quoted||(r.appendCell=!1,r.appendField=!0):e[t]===a.lineSeparator&&(r.quoted||(r.appendCell=!1,r.appendField=!0,r.appendRow=!0)),r.appendCell&&(l+=e[t]),r.appendField&&(ae(te(l,a),o,r),l=""),r.appendRow&&(re(o,s,r),o=[]),r.lineOffset++,r.fieldOffset++;o.length&&(ae(te(l,a),o,r),re(o,s,r)),t(s)}else n(Error("Empty CSV text"))})})(e,t).then(e=>{const t=e[0].filter(e=>"string"==typeof e);a(e.filter((e,t)=>t>0).map(e=>{const a={};return t.forEach((t,r)=>{a[t]=e[r]}),a}))})});class se{map(e){return e.map(e=>this._map(e)).sort((e,t)=>{const a=e.country.localeCompare(t.country);return 0===a?e.state.localeCompare(t.state):a})}_map(e){const t={values:[]};return Object.keys(e).forEach(a=>{if(a.match(/State/))t.state=e[a];else if(a.match(/Country/))t.country=e[a].replace(/\*/,"");else if(a.match(/Lat/))t.lat=parseFloat(e[a]);else if(a.match(/Long/))t.lon=parseFloat(e[a]);else{const r=parseInt(e[a],10),n=new Date(a),s=Date.UTC(n.getFullYear(),n.getMonth(),n.getDate());t.values.push({timestamp:s,value:r})}}),t.values.sort((e,t)=>e.timestamp-t.timestamp),Object.freeze(t)}}class oe{map(e){return e.map(e=>this._map(e)).sort((e,t)=>{const a=e.country.localeCompare(t.country);return 0===a?e.state.localeCompare(t.state):a})}_map(e){const t={};return Object.keys(e).forEach(a=>{a.match(/State/)?t.state=e[a]:a.match(/Country/)?t.country=e[a].replace(/\*/,""):a.match(/Lat/)?t.lat=parseFloat(e[a]):a.match(/Long/)?t.lon=parseFloat(e[a]):a.match(/Population/)?t.population=parseInt(e[a]):a.match(/UID/)?t.uid=parseInt(e[a]):a.match(/iso2/)?t.iso2=e[a]:a.match(/iso3/)?t.iso3=e[a]:a.match(/code3/)?t.code3=parseInt(e[a]):a.match(/FIPS/)?t.fips=parseInt(e[a]):a.match(/Admin2/)&&(t.admin2=e[a])}),Object.freeze(t)}}var le,e;(e=le||(le={})).CONFIRMED="confirmed",e.DEATHS="deaths",e.RECOVERED="recovered",e.LOOKUP="lookup";export class ModelCollector{constructor(e=new se,t=new oe){this._modelMapper=e,this._lookupMapper=t}async collect(){const e=await this._fetchLookup(),t=await this._fetchModel(le.CONFIRMED),a=await this._fetchModel(le.DEATHS),r=await this._fetchModel(le.RECOVERED);return this.merge(t,a,r,e)}findSeries(e,t){const a=t.find(t=>t.timestamp===e);return a?a.value:0}async merge(e,t,a,r){return new Promise(n=>{n(e.filter(e=>"Canada"!==e.country||"Recovered"!==e.state).map(e=>{const n=r.find(t=>{let a=t.country.localeCompare(e.country);return 0===a&&(a=t.state.localeCompare(e.state)),0===a}),s=t.find(t=>t.country===e.country&&t.state===e.state),o=a.find(t=>t.country===e.country&&t.state===e.state),l=e.values.map(e=>Object.freeze({confirmed:e.value,deaths:this.findSeries(e.timestamp,s?s.values:[]),recovered:this.findSeries(e.timestamp,o?o.values:[]),timestamp:e.timestamp}));return Object.freeze({country:e.country,lat:e.lat,lon:e.lon,state:e.state,population:n&&n.population||0,values:Object.freeze(l)})}))})}async _fetchModel(e){return this._fetch(e).then(e=>ne(e)).then(e=>this._modelMapper.map(e))}async _fetchLookup(){return this._fetch(le.LOOKUP).then(e=>ne(e)).then(e=>this._lookupMapper.map(e))}async _fetch(e){const t=new Request(this._fetchUrl(e),{headers:this._fetchHeaders(),method:"GET"});return fetch(t,{credentials:"same-origin"}).then(e=>e.text())}_fetchHeaders(){return{"Accept-Encoding":"gzip, deflate, br"}}_fetchUrl(e){return e===le.LOOKUP?"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv":`https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_${e}_global.csv`}}export default ModelCollector;